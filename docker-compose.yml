version: "3.9"

services:
  shelly_mysql:
    image: mysql:8.0
    container_name: shelly_mysql_local
    ports:
      - "13306:3306"
    environment:
      - TZ=Europe/Rome
      - MYSQL_ROOT_PASSWORD=local
      - MYSQL_DATABASE=dati
      - MYSQL_USER=myuser
      - MYSQL_PASSWORD=mypassword
    volumes:
      - shelly_mysql_data:/var/lib/mysql
    restart: always
    networks:
      - shelly_monitoring

  shelly_logger:
    build: ./logger
    container_name: shelly_logger_local
    volumes:
      - ./logger:/app
    working_dir: /app
    command: /app/entrypoint.sh
    environment:
      - TZ=Europe/Rome
      - SHELLY_IP=192.168.1.9
      - MYSQL_HOST=shelly_mysql
      - MYSQL_USER=myuser
      - MYSQL_PASSWORD=mypassword
      - MYSQL_DATABASE=dati
    restart: always
    depends_on:
      - shelly_mysql
    ports:
      - "15000:5000"
    networks:
      - shelly_monitoring
    extra_hosts:
      - "shelly_device:192.168.11.208"  

  shelly_grafana:
    image: grafana/grafana
    container_name: shelly_grafana_local
    environment:
      - TZ=Europe/Rome
      - GF_INSTALL_PLUGINS=speakyourcode-button-panel
    ports:
      - "13000:3000"
    volumes:
      - shelly_grafana_data:/var/lib/grafana
      - ./flask/config.json:/etc/grafana/config.json 
    restart: always
    networks:
      - shelly_monitoring

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: shelly_phpmyadmin_local
    ports:
      - "18080:80"  # Verifica che la porta 8080 non sia gi√† in uso
    environment:
      - PMA_HOST=shelly_mysql
      - PMA_USER=myuser
      - PMA_PASSWORD=mypassword
    restart: always
    depends_on:
      - shelly_mysql
    networks:
      - shelly_monitoring


  flask:
    build: ./flask
    container_name: shelly_flask
    ports:
      - "15001:5000"  # Espone il servizio sulla porta 5000
    volumes:
      - ./flask:/app  # Monta la directory locale nel contenitore

    environment:
      - TZ=Europe/Rome
      - CLIENT_SECRET=ta-secret.EIOXZ12%eEACq43R
      - FLASK_APP=app.py
      - MYSQL_HOST=shelly_mysql
      - MYSQL_USER=myuser
      - MYSQL_PASSWORD=mypassword
      - MYSQL_DATABASE=dati
    depends_on:
      - shelly_mysql
    networks:
      - shelly_monitoring
    extra_hosts:
      - host.docker.internal:192.168.1.4   
    restart: always
    command: flask run --host=0.0.0.0 --port=5000 --reload


  tesla_http_proxy:
    image: tesla/vehicle-command:latest
    ports:
      - "4443:4443"
    environment:
      - TESLA_HTTP_PROXY_TLS_CERT=/config/cert.pem
      - TESLA_HTTP_PROXY_TLS_KEY=/config/key.pem
      - TESLA_HTTP_PROXY_HOST=0.0.0.0
      - TESLA_HTTP_PROXY_PORT=4443
      - TESLA_HTTP_PROXY_TIMEOUT=10s
      - TESLA_KEY_FILE=/config/private-key.pem
      - TESLA_VERBOSE=true
    volumes:
      - ./tesla-proxy-config:/config
    restart: always
    networks:
      - shelly_monitoring  
       
  
networks:
  shelly_monitoring:
    name: shelly_monitoring  # Assegna un nome fisso alla rete

volumes:
  shelly_mysql_data:
  shelly_grafana_data:
